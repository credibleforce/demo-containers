# syntax=docker/dockerfile:1
################################################################################
# 1️⃣  Build stage – pull the PoC and install its deps
################################################################################
FROM node:20-slim AS builder

# Need git only while we build
RUN apt-get update -qq \
 && apt-get install -y --no-install-recommends git ca-certificates \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Shallow-clone keeps the layer tiny
RUN git clone https://github.com/ForbiddenProgrammer/CVE-2021-21315-PoC . \
	&& npm i

################################################################################
# 2️⃣  Runtime stage – nothing but Node + your app
################################################################################
FROM node:20-slim

ENV NODE_ENV=production PORT=3000

WORKDIR /app
COPY --from=builder /app .

EXPOSE ${PORT}
CMD ["npm","start"]